
### Шаг 1. Вводим новые характеристики

- **Физическая защита (ФЗ)** — снижает физический урон.
- **Магическая защита (МЗ)** — снижает магический урон.
- **Магический урон (МУ)** — часть урона, игнорирующая физическую защиту.
- **Уклонение (Уклон)** — шанс избежать атаки.
- **Удача (Удача)** — влияет на вероятность критов, эффектов (например, шанс гранаты, шанс разыграть 3 карту).

---

### Шаг 2. Анализ контр-системы и характеристик героев

| Юнит          | Контрит                          | Заметки по балансу                                     |
|---------------|---------------------------------|-------------------------------------------------------|
| Щит+меч       | Лук                             | Высокая броня, значит высокая ФЗ, низкий МЗ           |
| Копьё         | Кавалерия                      | Средняя ФЗ, средняя мобильность                        |
| Лук           | Маги                           | Высокая дальность и скорость, низкая броня (ФЗ и МЗ)  |
| Молот         | Щит+меч                       | Высокий физический урон, пробивает броню (часть урона МУ) |
| Мушкет        | Щит+меч                       | Дальний пробивной урон, средний МУ                      |
| Кавалерия     | Лук и маги                    | Высокая мобильность, средний ФЗ, низкий МЗ             |
| Магия         | Низкая мобильность            | Высокий МУ, низкая ФЗ, высокая МЗ                       |

---

### Шаг 3. Предложения по характеристикам героев

| Герой            | Класс     | HP  | Урон   | ФЗ  | МЗ  | МУ  | Уклон | Удача | Комментарии                             |
| ---------------- | --------- | --- | ------ | --- | --- | --- | ----- | ----- | --------------------------------------- |
| aimed shot       | Мушкет    | 34  | 100    | 5   | 5   | 15  | 7%    | 33%   | Шанс критического урона — высокая удача |
| Arrow protection | Мушкет    | 40  | 80     | 15  | 20  | 10  | 8%    | 10%   | Уменьшает урон от стрел — высокая МЗ    |
| Big shot         | Лук       | 45  | 90     | 10  | 5   | 10  | 5%    | 15%   | Каждая 5 атака — бонус к урону          |
| crow herd        | Маг       | 75  | 150    | 10  | 15  | 20  | 5%    | 10%   | Призывает воронов — средняя защита      |
| dwarves magic    | Маг       | 80  | 150    | 15  | 20  | 40  | 5%    | 10%   | Призывает юнитов — средняя защита       |
| finishing off    | Лук       | 45  | 90     | 15  | 10  | 20  | 7%    | 10%   | Урон растёт при низком ХП               |
| Grenade          | Мушкет    | 35  | 70     | 10  | 5   | 10  | 10%   | 23%   | Шанс гранаты — высокая удача            |
| injection        | Молот     | 135 | 160/40 | 40  | 20  | 40  | 2%    | 10%   | Уменьшает броню — высокая ФЗ            |
| Odin's revenge   | Кавалерия | 55  | 70/40  | 20  | 30  | 40  | 3%    | 5%    | Магический урон слабый, увеличить МЗ    |
| Raise shields    | Щит+меч   | 85  | 105    | 35  | 25  | 10  | 5%    | 5%    | Повышенная ФЗ и МЗ для отряда           |
| soldier's honor  | Щит+меч   | 80  | 130    | 30  | 15  | 10  | 5%    | 5%    | Увеличение сопротивления при уроне      |
| taro cards       | Маг       | 35  | 70     | 10  | 5   | 10  | 5%    | 15%   | +5% к статам — добавить шанс удачи      |
| gladiator        | Копьё     |     |        |     |     |     |       |       |                                         |
| Knight           | Молот     |     |        |     |     |     |       |       |                                         |

---

### Шаг 4. Корректировки по контрам

- **Лук**: низкая броня (ФЗ 5-10), низкая МЗ (5-10), высокая скорость атаки, высокая удача (20-30%) для шанса критов и специальных эффектов.
- **Копьё**: средняя ФЗ (20-30), низкая МЗ (5-10), средний урон, средняя мобильность.
- **Молот**: высокая ФЗ (30-40), высокий МУ (30-50) — чтобы пробивать броню, низкий уклон (3-5%), средняя удача.
- **Мушкет**: средняя ФЗ (15-20), средний МУ (25-35), высокая удача (20-25%) для шанса пробивного урона.
- **Кавалерия**: средняя ФЗ (20-25), низкая МЗ (5-10), высокая мобильность, средний уклон (7-10%), средняя удача (10-15%).
- **Магия**: низкая ФЗ (5-10), высокая МЗ (30-40), высокий МУ (50-70), низкий уклон (3%), низкая удача (5-10%).
- **Щит+меч**: 

---

### Шаг 5. Итоговые рекомендации по балансу героев

| Герой            | HP  | Урон   | ФЗ  | МЗ  | МУ  | Уклон | Удача | Комментарии                                                            |
| ---------------- | --- | ------ | --- | --- | --- | ----- | ----- | ---------------------------------------------------------------------- |
| taro cards       | 35  | 70     | 10  | 5   | 10  | 5%    | 15%   | Карты дают бонусы, удача влияет на шанс 3 карты                        |
| Odin's revenge   | 55  | 70/40  | 20  | 30  | 40  | 3%    | 5%    | Магический урон слабый, но частый, высокая МЗ                          |
| injection        | 135 | 160/40 | 40  | 20  | 40  | 2%    | 10%   | Высокая броня, уменьшает броню врага                                   |
| Raise shields    | 85  | 105    | 35  | 25  | 10  | 5%    | 5%    | Увеличивает сопротивление, отлично против физического и дальнего урона |
| Grenade          | 35  | 70     | 10  | 5   | 10  | 10%   | 23%   | Высокая удача для гранат, средний урон                                 |
| dwarves magic    | 80  | 150    | 15  | 20  | 40  | 5%    | 10%   | Призывает подкрепления, сбалансирован                                  |
| finishing off    | 45  | 90     | 15  | 10  | 20  | 7%    | 10%   | Урон сильно растёт при низком хп врага                                 |
| soldier's honor  | 80  | 130    | 30  | 15  | 10  | 5%    | 5%    | Хорошая выживаемость, растущая защита при уроне                        |
| Arrow protection | 40  | 80     | 15  | 20  | 10  | 8%    | 10%   | Сильная защита от стрел, полезен против луков                          |
| Big shot         | 45  | 90     | 10  | 5   | 10  | 5%    | 15%   | Бонус урона каждая 5 атака — для устойчивого урона                     |
| aimed shot       | 34  | 100    | 5   | 5   | 15  | 7%    | 33%   | Высокий шанс критического урона — стекать с удачей                     |
| crow herd        | 75  | 150    | 10  | 15  | 20  | 5%    | 10%   | Призывает воронов, сбалансирован по защите                             |
| gladiator        |     |        |     |     |     |       |       |                                                                        |
| Knight           |     |        |     |     |     |       |       |                                                                        |

---

### Шаг 6. Общие советы по балансу

- **Физическая защита** должна чётко отражать роль героя: танки и щитоносцы — высокая ФЗ, стрелки и маги — низкая.
- **Магическая защита** важна для магов и героев с магическим уроном, чтобы избежать легкой смерти от контр-магии.
- **Магический урон** стоит выделять отдельно, чтобы пробивать броню и создавать угрозу для щитоносцев.
- **Уклонение** — небольшой процент, чтобы не делать героя слишком «непобедимым», но чтобы атаки не всегда попадали.
- **Удача** — влияет на шанс срабатывания уникальных способностей и критов, варьируется от 5% до 33%.

---

## Формулы расчёта урона

Пусть:

- **BaseDamage** — базовый урон атаки.
- **PhysicalDamagePortion** — часть урона, которая физическая (например, 70% от BaseDamage).
- **MagicDamagePortion** — часть урона, которая магическая (оставшиеся 30%).
- **PhysicalArmor** — физическая защита цели.
- **MagicArmor** — магическая защита цели.
- **DodgeChance** — шанс уклонения (0…1).
- **CritChance** — шанс критического удара (0…1).
- **CritMultiplier** — множитель урона при критическом ударе (например, 1.5 или 2.0).
- **Luck** — дополнительный шанс для спецэффектов (0…1).

---

### 1. Проверка уклонения

Если случайное число [0,1) < DodgeChance — атака промахивается, урон = 0.

---

### 2. Расчёт урона с учётом брони

Физическая броня снижает физический урон по формуле:

``` 
PhysicalDamageAfterArmor = PhysicalDamagePortion * (100 / (100 + PhysicalArmor))
```

Магическая броня снижает магический урон аналогично:

```
MagicDamageAfterArmor = MagicDamagePortion * (100 / (100 + MagicArmor))
```

---

### 3. Итоговый урон

```
DamageAfterArmor = PhysicalDamageAfterArmor + MagicDamageAfterArmor
```

---

### 4. Критический урон

Если случайное число < CritChance, то

```
DamageFinal = DamageAfterArmor * CritMultiplier
```

Иначе

```
DamageFinal = DamageAfterArmor
```

---

### 5. Пример кода на C#

```csharp
using System;

public class CombatCalculator
{
    private static Random rng = new Random();

    public static double CalculateDamage(
        double baseDamage, 
        double physicalPortion, // 0..1
        double magicPortion,    // 0..1, physicalPortion + magicPortion = 1
        double physicalArmor,
        double magicArmor,
        double dodgeChance,     // 0..1
        double critChance,      // 0..1
        double critMultiplier  // например, 1.5
    )
    {
        // Проверка уклонения
        if (rng.NextDouble() < dodgeChance)
        {
            Console.WriteLine("Атака промахнулась!");
            return 0;
        }

        // Урон после брони
        double physicalDamageAfterArmor = baseDamage * physicalPortion * (100.0 / (100.0 + physicalArmor));
        double magicDamageAfterArmor = baseDamage * magicPortion * (100.0 / (100.0 + magicArmor));

        double damageAfterArmor = physicalDamageAfterArmor + magicDamageAfterArmor;

        // Проверка крита
        if (rng.NextDouble() < critChance)
        {
            damageAfterArmor *= critMultiplier;
            Console.WriteLine("Критический урон!");
        }

        return damageAfterArmor;
    }
}

// Пример использования:
class Program
{
    static void Main()
    {
        double baseDamage = 100;
        double physicalPortion = 0.7; // 70% физического урона
        double magicPortion = 0.3;    // 30% магического
        double physicalArmor = 40;
        double magicArmor = 20;
        double dodgeChance = 0.1;     // 10% шанс уклонения
        double critChance = 0.2;      // 20% шанс крита
        double critMultiplier = 1.5;  // 50% больше урона при крите

        double damage = CombatCalculator.CalculateDamage(
            baseDamage, physicalPortion, magicPortion, physicalArmor, magicArmor, dodgeChance, critChance, critMultiplier);

        Console.WriteLine($"Итоговый урон: {damage:F2}");
    }
}
```

---
